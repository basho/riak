%% -*- mode: erlang;erlang-indent-level: 4;indent-tabs-mode: nil -*-
{sub_dirs, ["rel", "apps/riak"]}.

{cover_enabled, true}.

{lib_dirs, ["apps/riak"]}.

%% TODO: Disable warnings for now.
%% TODO: nowarn_export_all on for now.
{erl_opts, [nowarn_export_all,
  		debug_info %% , fail_on_warning
		]}.

{eunit_opts, [verbose]}.

{project_plugins, [rebar3_cuttlefish]}.

{deps, [
	%% New deps, pinning for up-front compilation issues.
	{poolboy, ".*", {git, "https://github.com/Kyorai/poolboy.git", {branch, "r21"}}},

	%% Standard top-level Riak dependencies.
        {lager_syslog, ".*", {git, "git://github.com/basho/lager_syslog.git", {tag, "3.0.3"}}},
        {cluster_info, ".*", {git, "git://github.com/basho/cluster_info.git", {branch, "develop-3.0"}}},
        {riak_auth_mods, ".*", {git, "git://github.com/basho/riak_auth_mods.git", {branch, "develop-3.0"}}},
        {riak_repl_pb_api, ".*", {git, "git://github.com/basho/riak_repl_pb_api.git", {branch, "develop-3.0"}}},
        {riak_repl, ".*", {git, "git://github.com/basho/riak_repl.git", {branch, "develop-3.0"}}},
	{riak_kv, ".*", {git, "git://github.com/basho/riak_kv.git", {branch, "develop-3.0"}}},
	{yokozuna, ".*", {git, "git://github.com/basho/yokozuna.git", {branch, "develop-3.0"}}}
       ]}.

{profiles,
 [
  {test, [{deps, [meck]}]},
  {prod,
   [
    {relx,
     [
      {include_erts, true},
      {dev_mode, false}
     ]
    }
   ]}
 ]}.

{relx, [
        {release, {riak, "v3.0.0"}, [riak]},
        {vm_args, "config/vm.args"},
        {extended_start_script, true},
        {dev_mode, true},
        {include_erts, false},
	{overlay_vars, "config/vars.config"},
	{overlay, [
	           %% Create runtime directories
		   {mkdir, "data/ring"},
		   {mkdir, "log"},

		   %% Copy advanced configuration
		   {template, "config/advanced.config", "etc/advanced.config"},

		   %% Copy additional bin scripts
		   {template, "rel/files/riak-admin", "bin/riak-admin"},
		   {template, "rel/files/riak-debug", "bin/riak-debug"},
		   {template, "rel/files/riak-repl", "bin/riak-repl"},

		   %% Handle the optional patches
		   {mkdir, "lib/basho-patches"},

                   %% cuttlefish
                   {mkdir, "share/schema"},

                   {template, "rel/files/riak.schema", "share/schema/10-riak.schema"},
                   {template, "{{lib_dirs}}/cuttlefish/priv/erlang_vm.schema", "share/schema/11-erlang_vm.schema"},
                   {template, "{{lib_dirs}}/riak_core/priv/riak_core.schema", "share/schema/12-riak_core.schema"},
                   {template, "{{lib_dirs}}/riak_api/priv/riak_api.schema", "share/schema/13-riak_api.schema"},
                   {template, "{{lib_dirs}}/riak_kv/priv/riak_kv.schema", "share/schema/14-riak_kv.schema"},
                   {template, "{{lib_dirs}}/riak_sysmon/priv/riak_sysmon.schema", "share/schema/15-riak_sysmon.schema"},
                   {template, "{{lib_dirs}}/bitcask/priv/bitcask.schema", "share/schema/16-bitcask.schema"},
                   {template, "{{lib_dirs}}/bitcask/priv/bitcask_multi.schema", "share/schema/17-bitcask_multi.schema"},
                   {template, "{{lib_dirs}}/riak_kv/priv/multi_backend.schema", "share/schema/20-multi_backend.schema"},
                   {template, "{{lib_dirs}}/eleveldb/priv/eleveldb.schema", "share/schema/21-leveldb.schema"},
                   {template, "{{lib_dirs}}/eleveldb/priv/eleveldb_multi.schema", "share/schema/22-leveldb_multi.schema"},
                   {template, "{{lib_dirs}}/yokozuna/priv/yokozuna.schema", "share/schema/30-yokozuna.schema"}

		  ]}]}.
